##
## Velocity Template for DisplayUsernamePasswordPage view-state
##
## Velocity context will contain the following properties
## flowExecutionUrl - the form action location
## flowRequestContext - the Spring Web Flow RequestContext
## flowExecutionKey - the SWF execution key (this is built into the flowExecutionUrl)
## profileRequestContext - root of context tree
## authenticationContext - context with authentication request information
## authenticationErrorContext - context with login error state
## authenticationWarningContext - context with login warning state
## ldapResponseContext - context with LDAP state (if using native LDAP)
## rpUIContext - the context with SP UI information from the metadata
## encoder - HTMLEncoder class
## request - HttpServletRequest
## response - HttpServletResponse
## environment - Spring Environment object for property resolution
##
#set ($rpContext = $profileRequestContext.getSubcontext('net.shibboleth.idp.profile.context.RelyingPartyContext'))
#set ($username = $authenticationContext.getSubcontext('net.shibboleth.idp.authn.context.UsernamePasswordContext', true).getUsername())
##
<!DOCTYPE html>
<html>
        <head>
        <meta charset="utf-8">
        <title>#springMessageText("idp.title", "Web Login Service")</title>
        <link href="<%= @metadata_information['en']['url_LogoOrg_32x32'] %>" rel="shortcut icon" type="image/x-icon" />
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/main.css">
        </head>
        <body>
    <div class="wrapper">
      <div class="container">
        <header>
          <img src="$request.getContextPath()#springMessage("idp.logo")" alt="#springMessageText("idp.logo.alt-text", "logo")">
        </header>

        <div class="content">
          <div class="column one">
            <form action="$flowExecutionUrl" method="post">

              #parse("login-error.vm")

              #set ($serviceName = $rpUIContext.serviceName)
              #if ($serviceName && !$rpContext.getRelyingPartyId().contains($serviceName))
                <legend>
                  #springMessageText("idp.login.loginTo", "Login to") $encoder.encodeForHTML($serviceName)
                </legend>
              #end

              <div class="form-element-wrapper">
                <label for="username">#springMessageText("idp.login.username", "Username")</label>
                <input class="form-element form-field" id="username" name="j_username" type="text"
                        value="#if($username)$encoder.encodeForHTML($username)#end">
              </div>

             <div class="form-element-wrapper">
                <label for="password">#springMessageText("idp.login.password", "Password")</label>
                <input class="form-element form-field" id="password" name="j_password" type="password" value="">
              </div>

              <div class="form-element-wrapper">
                <input type="checkbox" name="donotcache" value="1"> #springMessageText("idp.login.donotcache", "Don't Remember Login")
              </div>

              <div class="form-element-wrapper">
                <input id="_shib_idp_revokeConsent" type="checkbox" name="_shib_idp_revokeConsent" value="true">
                #springMessageText("idp.attribute-release.revoke", "Clear prior granting of permission for release of your information to this service.")
              </div>

              <div class="form-element-wrapper">
                <button class="form-element form-button" type="submit" name="_eventId_proceed">#springMessageText("idp.login.login", "Login")</button>
              </div>
            </form>

                        #*
              //
              //    SP Description & Logo (optional)
              //    These idpui lines will display added information (if available
              //    in the metadata) about the Service Provider (SP) that requested
              //    authentication. These idpui lines are "active" in this example
              //    (not commented out) - this extra SP info will be displayed.
              //    Remove or comment out these lines to stop the display of the
              //    added SP information.
              //
            *#
            #set ($logo = $rpUIContext.getLogo())
            #if ($logo)
              <img src= "$encoder.encodeForHTMLAttribute($logo)"
                  alt="$encoder.encodeForHTMLAttribute($serviceName)">
            #end
            #set ($desc = $rpUIContext.getServiceDescription())
            #if ($desc)
              $encoder.encodeForHTML($desc)
            #end

          </div>
          <div class="column two">
            <ul class="list list-help">
              <li class="list-help-item"><a href="#"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.forgotPassword", "Forgot your password?")</a></li>
              <li class="list-help-item"><a href="#"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.needHelp", "Need Help?")</a></li>
            </ul>
          </div>
        </div>
      </div>

      <footer>
        <div class="container container-footer">
          <p class="footer-text">#springMessageText("idp.footer", "Insert your footer text here.")</p>
        </div>
      </footer>
    </div>

        </body>
</html>






<%%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%%@ page import="edu.internet2.middleware.shibboleth.idp.util.HttpServletHelper" %>
<%%@ page import="org.opensaml.util.storage.StorageService" %>
<%%@ page import="edu.internet2.middleware.shibboleth.idp.authn.LoginContext" %>
<%%@ page import="edu.internet2.middleware.shibboleth.idp.authn.LoginHandler" %>
<%%@ page import="edu.internet2.middleware.shibboleth.common.relyingparty.RelyingPartyConfigurationManager" %>
<%%@ page import="org.opensaml.saml2.metadata.EntityDescriptor" %>
<%%@ page import="org.opensaml.saml2.metadata.ContactPerson" %>
<%%@ page import="org.opensaml.saml2.metadata.ContactPersonTypeEnumeration" %>
<%%@ page import="org.opensaml.saml2.metadata.RequestedAttribute" %>
<%%@ page import="java.util.List" %>
<%%@ page import="java.util.Locale"%>
<%%
   StorageService storageService = null;
   LoginContext loginContext = null;
   RelyingPartyConfigurationManager rpConfigMngr = null;
   EntityDescriptor metadata = null;
   
   try {
      storageService = HttpServletHelper.getStorageService(application);
      loginContext = HttpServletHelper.getLoginContext(storageService,application, request);
      rpConfigMngr = HttpServletHelper.getRelyingPartyConfigurationManager(application);
      metadata = HttpServletHelper.getRelyingPartyMetadata(loginContext.getRelyingPartyId(), rpConfigMngr);   
   }
   catch (Exception e) {
      // Do nothing
   }
%>
<!DOCTYPE html>

  <c:set var="language" value="${not empty param.language ? param.language : not empty language ? language : pageContext.request.locale.language}" scope="session" />
  <fmt:setLocale value="${language}" />
  <fmt:setBundle basename="messages"/>

  <%%@ taglib uri="urn:mace:shibboleth:2.0:idp:ui" prefix="idpui" %>
  <html lang="${language}">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <c:choose>
      <%
      @metadata_information.sort.each do |lang, v|
        if v.is_a?(Hash) and lang != "en"
          %>
          <c:when test="${language == '<%=lang%>'}">
            <title><%= @metadata_information[lang]['orgDisplayName'] %></title>
            <link href="<%= @metadata_information[lang]['url_LogoOrg_32x32'] %>" rel="shortcut icon" type="image/x-icon" />
          </c:when>
          <%
        end
      end
      %>
      <c:otherwise>
        <title><%= @metadata_information['en']['orgDisplayName'] %></title>
        <link href="<%= @metadata_information['en']['url_LogoOrg_32x32'] %>" rel="shortcut icon" type="image/x-icon" />
      </c:otherwise>
      </c:choose>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="<%%= request.getContextPath()%>/login.css"/>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
      <script language="javascript">
           function setParam(name, value) {
              var l = window.location;

              /* build params */
              var params = {};        
              var x = /(?:\??)([^=&?]+)=?([^&?]*)/g;        
              var s = l.search;
              for(var r = x.exec(s); r; r = x.exec(s)) {
                 r[1] = decodeURIComponent(r[1]);
                 if (!r[2]) r[2] = '%%';
                 params[r[1]] = r[2];
              }

              /* set param */
              params[name] = encodeURIComponent(value);

              /* build search */
              var search = [];
              for(var i in params) {
                 var p = encodeURIComponent(i);
                 var v = params[i];
                 if (v != '%%') p += '=' + v;
                 search.push(p);
              }
              search = search.join('&');

              /* execute search */
              l.search = search;
           }

           function getParameterByName(name) {
              name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
              var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
              var results = regex.exec(location.search);
              return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
           }
      </script>
    </head>

    <c:choose>
    <%
    @metadata_information.sort.each do |lang, v|
      if v.is_a?(Hash) and lang != "en"
        %>
        <c:when test="${language == '<%=lang%>'}">
          <fmt:message key="footer" var="footer">
            <fmt:param value="<%= @metadata_information[lang]['orgDisplayName'] %>"/>
            <fmt:param value="<%= @metadata_information[lang]['orgDescription'] %>"/>
          </fmt:message>
        </c:when>
        <%
      end
    end
    %>
    <c:otherwise>
      <fmt:message key="footer" var="footer">
        <fmt:param value="<%= @metadata_information['en']['orgDisplayName'] %>"/>
        <fmt:param value="<%= @metadata_information['en']['orgDescription'] %>"/>
      </fmt:message>
    </c:otherwise>
    </c:choose>

    <body><div class="wrapper">
        <div class="container">
          <header>
            <%% if ("true".equals(request.getParameter("spinfo"))) { %>
             <idpui:serviceLogo minWidth="40" minHeight="40"></idpui:serviceLogo><br/>
             <b><idpui:serviceDescription><fmt:message key="spdescr"/></idpui:serviceDescription></b><br />
             <a href="javascript:setParam('spinfo', 'false');"><span class="item-marker">&lsaquo;</span> <fmt:message key="goback"/></a>
            <%% } else { %>
              <c:choose>
              <%
              @metadata_information.sort.each do |lang, v|
                if v.is_a?(Hash) and lang != "en"
                  %>
                  <c:when test="${language == '<%=lang%>'}">
                    <a id="logolink" class="logo" href="<%= @metadata_information[lang]['orgUrl'] %>"><img id="logoimg" src="<%= @metadata_information[lang]['url_LogoOrg_160x120']%>" alt="<%= @metadata_information[lang]['orgDisplayName']%>"/></a><br/><%= @metadata_information[lang]['orgDisplayName']%>
                  </c:when>
                  <%
                end
              end
              %>
              <c:otherwise>
                <a id="logolink" class="logo" href="<%= @metadata_information['en']['orgUrl'] %>"><img id="logoimg" src="<%= @metadata_information['en']['url_LogoOrg_160x120']%>" alt="<%= @metadata_information['en']['orgDisplayName']%>"/></a><br/><%= @metadata_information['en']['orgDisplayName']%>
              </c:otherwise>
              </c:choose>
            <%% } %>
          </header>
      
          <div class="content row">
            <%% if ("true".equals(request.getParameter("spinfo"))) { %>
              <ul>
              <li><span class="item-marker">&rsaquo;</span> <b><fmt:message key="description"/>:</b><br/>
              <idpui:serviceDescription>${unknown}</idpui:serviceDescription></li>
              <li><span class="item-marker">&rsaquo;</span> <b><fmt:message key="organization"/>:</b><br/>
              <script language="javascript">
                if ('<idpui:organizationDisplayName />') { 
                  document.write('<idpui:organizationDisplayName />');
                }
                else if ('<idpui:organizationName />') { 
                  document.write('<idpui:organizationName />');
                }
                else {
                  document.write('${unknown}');
                }
              </script></li>
              <li><span class="item-marker">&rsaquo;</span> <b><fmt:message key="contacts"/>:</b><br/>
              <script language="javascript">
              <%%
                 String contactLinks = "";
                 try {
                   for (ContactPerson contact : metadata.getContactPersons()) {
                     if (ContactPersonTypeEnumeration.TECHNICAL.equals(contact.getType())) {
                       if (!"".equals(contactLinks)) {
                         contactLinks += ", ";
                       }
                       contactLinks += "<a href=\"" + contact.getEmailAddresses().get(0).getAddress() + "\">";
                       contactLinks += contact.getGivenName().getName() + " " + contact.getSurName().getName();
                       contactLinks += "</a>";
                     }
                   }
                 } catch (NullPointerException e){
                   contactLinks = "";
                 }
                 %>
                 var langNoContacts = "<fmt:message key="nocontacts"/>";
                 if ('<%%= contactLinks %>' == '') document.write(langNoContacts);
                 else document.write('<%%= contactLinks %>');
              </script></li>
              <fmt:message key="privacy" var="privacy"/>
              <fmt:message key="infopage" var="infopage"/>
              <li><span class="item-marker">&rsaquo;</span> <b><idpui:servicePrivacyURL cssId="spPrivacyURL" linkText="${privacy}"><fmt:message key="noprivacy"/></idpui:servicePrivacyURL></b></li>
              <li><span class="item-marker">&rsaquo;</span> <b><idpui:serviceInformationURL cssId="spInfoURL" linkText="${infopage}"><fmt:message key="noinfopage"/></idpui:serviceInformationURL></b></li>
              <li><span class="item-marker">&rsaquo;</span> <b><fmt:message key="requestedattrs"/>:</b><br/>
              <script language="javascript">
                var langPreLinkA = {
                  <% @metadata_information.sort.each do |l, mi| %>
                  "<%= l %>": "<%= mi['idpInfoUrl'] %>",
                  <% end %>
                };
            		var langPreLink = ("${language}" in langPreLinkA) ? langPreLinkA["${language}"] : langPreLinkA["en"];
                var langNoAttrs = "<fmt:message key="norequestedattrs"/>";

                <%%
                  String requestedAttributes = "";
                  try {
                    List<RequestedAttribute> itrReqAttr = metadata.getSPSSODescriptor("urn:oasis:names:tc:SAML:2.0:protocol").getDefaultAttributeConsumingService().getRequestAttributes();
                    for (RequestedAttribute reqAttr : itrReqAttr) {
                      if (reqAttr.isRequired()) {
                        if (!"".equals(requestedAttributes)) {
                          requestedAttributes += ", ";
                        }
                              
                        if ("".equals(reqAttr.getFriendlyName())) {
                          requestedAttributes += reqAttr.getName();
                        }
                        else {
                          requestedAttributes += "<a href=\"' + langPreLink + '#" + reqAttr.getFriendlyName() + "\">" + reqAttr.getFriendlyName() + "</a>";
                        }
                      }
                    }
                  } catch (NullPointerException e) {
                    requestedAttributes = "";
                  }
            
                  if ("".equals(requestedAttributes)) {
                    %>
                    document.write(langNoAttrs);
                    <%%
                  } else {
                    %>
                    document.write('<%%= requestedAttributes %>');
                  <%%
                  }
                %>
              </script></li>
              <li><span class="item-marker">&rsaquo;</span> <b><fmt:message key="optionalattrs"/>:</b><br/>
              <script language="javascript">
                 var langPreLinkA = {
                   <% @metadata_information.sort.each do |l, mi| %>
                   "<%= l %>": "<%= mi['idpInfoUrl'] %>",
                   <% end %>
                 };
             		 var langPreLink = ("${language}" in langPreLinkA) ? langPreLinkA["${language}"] : langPreLinkA["en"];
                 var langNoAttrs = "<fmt:message key="nooptionalattrs"/>";

                 <%%
                   String desiredAttributes = "";
                   try {
                     List<RequestedAttribute> itrReqAttr = metadata.getSPSSODescriptor("urn:oasis:names:tc:SAML:2.0:protocol").getDefaultAttributeConsumingService().getRequestAttributes();
                     for (RequestedAttribute reqAttr : itrReqAttr) {
                       if (!reqAttr.isRequired()) {
                         if (!"".equals(desiredAttributes)) {
                           desiredAttributes += ", ";
                         }

                         if ("".equals(reqAttr.getFriendlyName())) {
                           desiredAttributes += reqAttr.getName();
                         }
                         else {
                           desiredAttributes += "<a href=\"' + langPreLink + '#" + reqAttr.getFriendlyName() + "\">" + reqAttr.getFriendlyName() + "</a>";
                         }
                       }
                     }
                   } catch (NullPointerException e) {
                     desiredAttributes = "";
                   }
                   if ("".equals(desiredAttributes)) {
                     %>
                     document.write(langNoAttrs);
                     <%%
                   } else {
                     %>
                     document.write('<%%= desiredAttributes %>');
                     <%%
                   }
                 %>
              </script></li>           
              </ul>
            <%% } else { %>
            <div class="column one col-sm-4">
              <%% if (request.getAttribute("actionUrl") != null){ %>
                <form id="login" action="<%%= request.getAttribute("actionUrl") %>" method="post">
              <%% } else { %>
                <form id="login" action="j_security_check" method="post">
              <%% } %>

                <%% if ("true".equals(request.getAttribute("loginFailed"))) { %>
                <section>
                 <%%
                 // Viene richiesto se il login e' fallito e viene segnalato errore di autenticazione
                 if (request.getAttribute(LoginHandler.AUTHENTICATION_EXCEPTION_KEY) != null) {
                    Throwable ex = (Throwable)request.getAttribute(LoginHandler.AUTHENTICATION_EXCEPTION_KEY);
                    if (ex.getMessage().contains("PASSWORD_EXPIRED")) {
                       %>
                       <p class="form-element form-error"><fmt:message key="pwdexpired"/>. <a href='/pw/changepw.php'><fmt:message key="changepwd"/></a>.</p>
                       <%%
                    } else if (ex.getMessage().contains("CHANGE_AFTER_RESET")) {
                       %>
                       <p class="form-element form-error"><fmt:message key="invalidpwd"/>. <a href='/pw/changepw.php'><fmt:message key="changepwd"/></a>.</p>
                       <%%
                     } else if (ex.getMessage().contains("ACCOUNT_LOCKED")){
                       %>
                       <p class="form-element form-error"><fmt:message key="locked"/>.</p>
                       <%%
                     } else {
                       %>
                       <p class="form-element form-error"><fmt:message key="wrong"/>.</p>
                       <%%
                     }
                  }
                  %>
                </section>
                <%% } %>

                <legend id="spName">
                  <fmt:message key="loginto"/> <idpui:serviceName/>
                </legend>

                <section>
                  <label for="username" class="hidden"><fmt:message key="username"/></label>
                  <input class="form-element form-field" name="j_username" type="text" value="">
                </section>

                <section>
                  <label for="password" class="hidden"><fmt:message key="password"/></label>
                  <input class="form-element form-field" name="j_password" type="password" value="">
                </section>

                <section>
                  <button class="form-element form-button" type="submit"><fmt:message key="login"/></button>
                </section>
              </form>
              
              <%%
                //
                //    SP Description & Logo (optional)
                //    These idpui lines will display added information (if available
                //    in the metadata) about the Service Provider (SP) that requested
                //    authentication. These idpui lines are "active" in this example
                //    (not commented out) -- this extra SP info will be displayed.
                //    Remove or comment out these lines to stop the display of the
                //    added SP information.
                //
                //    Documentation: 
                //      https://wiki.shibboleth.net/confluence/display/SHIB2/IdPAuthUserPassLoginPage
                //
                //    Example:
              %>
                    <p>
                      <idpui:serviceLogo minWidth="40" minHeight="40"></idpui:serviceLogo><br/>
                      <idpui:serviceDescription><fmt:message key="spdescr"/></idpui:serviceDescription><br />
                      <a href="javascript:setParam('spinfo', 'true');"><span class="item-marker">&rsaquo;</span> <fmt:message key="moreinfo"/></a>
                    </p>

          </div>
          <div class="column two col-sm-4">
            <ul class="list list-help">
              <li class="list-help-item"><a href="/pw/changepw.php"><span class="item-marker">&rsaquo;</span> <fmt:message key="forgot"/></a></li>
              <li class="list-help-item"><a href="<%= @metadata_information['technicalIDPadminEmail'] %>"><span class="item-marker">&rsaquo;</span> <fmt:message key="help"/></a></li>
              <c:choose>
              <%
              @metadata_information.sort.each do |lang, v|
                if v.is_a?(Hash) and lang != "en"
                  %>
                  <c:when test="${language == '<%=lang%>'}">
                    <li class="list-help-item"><a href="<%= @metadata_information[lang]['idpInfoUrl'] %>"><span class="item-marker">&rsaquo;</span> <fmt:message key="info"/></a></li>
                    <li class="list-help-item"><a href="<%= @metadata_information[lang]['privacyPage'] %>"><span class="item-marker">&rsaquo;</span> <fmt:message key="privacy"/></a></li>
                  </c:when>
                  <%
                end
              end
              %>
              <c:otherwise>
                <li class="list-help-item"><a href="<%= @metadata_information['en']['idpInfoUrl'] %>"><span class="item-marker">&rsaquo;</span> <fmt:message key="info"/></a></li>
                <li class="list-help-item"><a href="<%= @metadata_information['en']['privacyPage'] %>"><span class="item-marker">&rsaquo;</span> <fmt:message key="privacy"/></a></li>
              </c:otherwise>
              </c:choose>
            </ul>

            <p>
            <%
            @metadata_information.sort.each do |lang, v|
              if v.is_a?(Hash) and lang != "en"
              %>
              <a href="javascript:setParam('language', '<%=lang%>');"><img height="16px" src="<%%= request.getContextPath()%>/images/<%=lang%>Flag.png"></a>
              <%
              end
            end
            %>
            <a href="javascript:setParam('language', 'en');"><img height="16px" src="<%%= request.getContextPath()%>/images/enFlag.png"></a>
            </p>
            <p>
            <a href="http://www.idem.garr.it"><img src="<%%= request.getContextPath()%>/images/IDEM_logo.png" alt="${idem}" style="width: 100px"/></a>
            </p>
          </div>
          <%% } %>
        </div>
      </div>

      <footer>
        <div class="container container-footer">
          <p class="footer-text">${footer}</p>
          </div>
      </footer>
    
  </body>
</html>
