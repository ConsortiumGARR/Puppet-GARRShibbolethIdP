<?php
include "SProvider.conf.php";
include "SProvider.metadata.php";

if (!mysql_connect("localhost", "<%= @dbuser %>", "<%= @dbpasswd %>"))
	die("Impossibile connettersi al database");
if (!mysql_select_db("<%= @dbname %>"))
	die("Impossibile selezionare il database");

$sps = array();
foreach ($SProviders as $key=>$value) {
	$sps[$key] = $value['Name'];
}
foreach ($metadataSProviders as $key=>$value) {
	if (!array_key_exists(trim($key), $sps)) $sps[trim($key)] = trim($value['Name']);
}

mysql_query("SET AUTOCOMMIT=0");
mysql_query("START TRANSACTION");
mysql_query("DELETE FROM sps");

$count = 0;
foreach ($sps as $key=>$value) {
	$query = "INSERT INTO sps VALUES ('".$key."', '".$value."')";
	#print $query . "\n";
	$result = mysql_query($query);
	if (!$result) {
		print "Error in updating SP database.\n";
		mysql_query("ROLLBACK");
		exit(1);
	}
	$count++;
}

mysql_query("COMMIT");
print "Update OK, inserted $count SPs.\n";
?>
